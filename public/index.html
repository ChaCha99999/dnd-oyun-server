<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Master V4.9 (Map Fix)</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- TEMEL --- */
        body { margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; background-color: #0f0f0f; background-image: radial-gradient(circle at center, rgba(0,0,0,0.4), #000), url('masa.jpg'); background-size: cover; background-position: center; font-family: 'Cinzel', serif; color: #dcdde1; user-select: none; }
        .glass-panel { background: rgba(18, 20, 16, 0.95); border: 1px solid #4b6b44; backdrop-filter: blur(8px); border-radius: 8px; box-shadow: 0 5px 25px rgba(0,0,0,0.8); }

        /* --- BUTONLAR & MENÜLER (EN ÜST KATMAN: 2000+) --- */
        .floating-btn { position: fixed; z-index: 2100; width: 55px; height: 55px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 22px; cursor: grab; background: linear-gradient(135deg, #2f3624, #0f120d); border: 2px solid #555; color: #aaa; box-shadow: 0 5px 15px rgba(0,0,0,0.5); transition: transform 0.1s; }
        .floating-btn:active { cursor: grabbing; transform: scale(0.95); } 
        #partyToggleBtn { top: 20px; left: 20px; border-color: #f1c40f; color: #f1c40f; }
        #dmToolsBtn { top: 90px; left: 20px; border-color: #e74c3c; color: #e74c3c; }
        #identityBtn { top: 160px; left: 20px; border-color: #3498db; color: #3498db; }
        #msgDmBtn { top: 230px; left: 20px; border-color: #0984e3; color: #0984e3; } 
        #dmLogBtn { top: 300px; left: 20px; border-color: #e84393; color: #e84393; display: none; }
        #battleModeBtn { bottom: 30px; left: 50%; transform: translateX(-50%); border-color: #e74c3c; color: #e74c3c; width: 70px; height: 70px; font-size: 32px; background: rgba(0,0,0,0.8); z-index: 2100; }

        /* YAN PANELLER (Z-INDEX YÜKSELTİLDİ) */
        .side-drawer { position: fixed; left: -360px; top: 0; width: 340px; height: 100vh; background: rgba(15, 15, 15, 0.98); border-right: 2px solid #4b6b44; z-index: 2050; transition: left 0.3s ease; display: flex; flex-direction: column; padding: 20px; padding-top: 60px; box-shadow: 10px 0 50px rgba(0,0,0,0.8); overflow-y: auto; }
        .side-drawer.open { left: 0; }
        .drawer-header { font-size: 18px; color: #f1c40f; text-align: center; border-bottom: 1px solid #4b6b44; padding-bottom: 10px; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center;}

        /* --- KARAKTER KARTI --- */
        .char-card { background: rgba(255,255,255,0.03); border: 1px solid #333; border-radius: 8px; padding: 10px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 8px; position: relative; transition: 0.3s; }
        .char-card.active-turn { border: 2px solid #2ecc71; box-shadow: 0 0 20px rgba(46, 204, 113, 0.6); background: rgba(46, 204, 113, 0.1); transform: scale(1.02); z-index: 10; }
        .char-header { display: flex; gap: 10px; align-items: center; } 
        .char-avatar-container { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #555; overflow: hidden; position: relative; cursor: pointer; background: #222; display: flex; justify-content: center; align-items: center; flex-shrink: 0;} .char-avatar-container img { width: 100%; height: 100%; object-fit: cover; }
        .char-details { flex-grow: 1; display: flex; flex-direction: column; gap: 4px; min-width: 0; } 
        .inp-name { background: transparent; border: none; color: #f1c40f; font-family: 'Cinzel', serif; font-weight: bold; font-size: 14px; width: 100%; border-bottom: 1px solid transparent; }
        .stat-row { display: flex; gap: 4px; } 
        .stat-box { display: flex; align-items: center; justify-content: center; gap: 2px; padding: 4px; border-radius: 4px; flex: 1; font-size: 9px; color:#aaa; flex-direction: column;}
        .box-hp { background: rgba(192, 57, 43, 0.2); border: 1px solid #c0392b; } 
        .box-sp { background: rgba(52, 152, 219, 0.2); border: 1px solid #3498db; }
        .box-lvl { background: rgba(52, 152, 219, 0.2); border: 1px solid #3498db; } 
        .box-init { background: rgba(155, 89, 182, 0.2); border: 1px solid #9b59b6; }
        .stat-dual { display: flex; align-items: center; gap: 2px; }
        .stat-input { width: 100%; background: transparent; border: none; color: #fff; text-align: center; font-weight: bold; font-family: 'Lato', sans-serif; font-size: 14px; }
        .stat-sep { color: #555; font-size: 12px; }
        .hp-bar-container { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; margin-top: 3px; }
        .hp-bar-fill { height: 100%; background: #2ecc71; width: 100%; transition: width 0.3s ease; }
        .sp-bar-fill { height: 100%; background: #3498db; width: 100%; transition: width 0.3s ease; }
        .card-actions { display: flex; justify-content: space-between; margin-top: 5px; padding-top: 5px; border-top: 1px solid rgba(255,255,255,0.1);} .icon-btn { cursor: pointer; color: #666; font-size: 14px; padding: 5px; transition: 0.2s; } .icon-btn:hover { color: #fff; }

        /* --- SAVAŞ ALANI (Z-INDEX AYARLANDI) --- */
        #battleArena { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1000; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); flex-direction: row; justify-content: space-between; padding: 40px; box-sizing: border-box; }
        .arena-column { width: 40%; height: 100%; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; padding: 15px; border-radius: 12px; background: rgba(20, 20, 20, 0.6); border: 1px solid #444; }
        .heroes-col { border-color: #2ecc71; } .enemies-col { border-color: #e74c3c; }
        .col-title { text-align: center; font-family: 'Cinzel'; font-size: 24px; margin-bottom: 10px; color: #fff; }
        .enemy-card { background: rgba(60, 20, 20, 0.8); border: 2px solid #e74c3c; border-radius: 8px; padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: 0.2s; }
        .enemy-card:hover { transform: scale(1.02); }
        .enemy-card.selected { border-color: #fff; box-shadow: 0 0 20px #fff; background: #444; }

        /* --- DM TOOLS & INPUTS --- */
        .dm-tool-row { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 15px; } .dm-tool-title { font-size: 14px; color: #e74c3c; margin-bottom: 10px; font-weight: bold; }
        .dm-btn { width: 100%; padding: 10px; margin-top: 5px; background: #333; border: 1px solid #555; color: #ddd; cursor: pointer; font-family: 'Lato', sans-serif; border-radius: 4px; transition: 0.2s; } .dm-btn:hover { background: #444; border-color: #e74c3c; color: #fff; }
        .dm-input { width: 100%; padding: 8px; background: rgba(0,0,0,0.5); border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; font-family: 'Lato', sans-serif;}
        .bestiary-select { width: 100%; padding: 8px; margin-bottom: 5px; background: #222; border: 1px solid #e74c3c; color: #fff; border-radius: 4px; font-family: 'Lato'; }

        /* --- MODALS (CENTERING & Z-INDEX) --- */
        .modal-overlay { 
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 6000; 
            background: rgba(0,0,0,0.85); 
            justify-content: center; align-items: center; 
        }
        .modal-content { background: #1a1a1a; padding: 20px; border-radius: 10px; border: 2px solid #555; text-align: center; width: 350px; }
        .identity-option { padding: 10px; margin: 5px 0; background: #222; border: 1px solid #444; color: #fff; cursor: pointer; } 
        .identity-option:hover { background: #3498db; } .identity-option.taken { opacity: 0.5; background: #444; pointer-events: none; }
        
        /* TIMER (GİZLİ BAŞLAR) */
        #timerOverlay { 
            display: none;
            position: fixed; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            font-size: 120px; 
            font-weight: 900; 
            color: #e74c3c; 
            pointer-events: none; 
            text-shadow: 0 0 30px red;
            font-family: 'Courier New', monospace;
            z-index: 7000;
        }

        /* --- HARİTA (KATMAN DÜZELTMESİ) --- */
        /* Z-Index 100: Sahnenin üzerinde ama menülerin altında */
        #activeMapContainer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 100; 
            display: none; 
            justify-content: center; align-items: center; 
            background: #000; 
            cursor: pointer; /* Kapatmak için tıklanabilir */
        }
        #activeMapImg { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* KARAKTER DETAY MODALI */
        .detail-window { width: 500px; max-width: 90%; height: 600px; background: #1a1a1a; border: 2px solid #f1c40f; border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .detail-header { padding: 15px; background: #222; border-bottom: 1px solid #444; display: flex; justify-content: space-between; align-items: center; font-family: 'Cinzel'; font-size: 18px; color: #f1c40f; }
        .detail-tabs { display: flex; background: #111; }
        .tab-btn { flex: 1; padding: 15px; background: transparent; border: none; color: #777; cursor: pointer; border-bottom: 3px solid transparent; font-family: 'Lato'; font-weight: bold; transition: 0.2s; }
        .tab-btn.active { color: #fff; border-bottom-color: #f1c40f; background: #222; }
        .detail-content { flex: 1; padding: 20px; overflow-y: auto; font-family: 'Lato'; text-align: left; }
        .tab-pane { display: none; } .tab-pane.active { display: block; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-group { background: #222; padding: 10px; border-radius: 5px; border: 1px solid #444; }
        .stat-label { font-size: 11px; color: #aaa; margin-bottom: 5px; display: block; }
        .item-list { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .list-item { background: #2d3436; padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #777; }
        .add-row { display: flex; gap: 5px; margin-bottom: 10px; }

        /* ZAR & LOGS */
        .scene { width: 100%; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; } 
        .dice-container { width: 250px; height: 250px; position: relative; transform-style: preserve-3d; transition: transform 0.8s; } 
        .d20-svg { width: 100%; height: 100%; filter: drop-shadow(0 0 15px rgba(241, 196, 15, 0.2)); }
        .dice-number { 
            font-size: 50px; font-weight: 900; color: #fff; 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); 
            text-shadow: 0 0 10px #000; 
            display:flex; justify-content:center; align-items:center; flex-direction:column; width:100%; z-index:10;
            pointer-events: none;
        }
        .roller-name { font-size: 18px; color: #f1c40f; font-family: 'Cinzel', serif; margin-bottom: 5px; text-shadow: 2px 2px 4px #000; }
        .dice-bar { display: flex; gap: 10px; margin-top: 20px; }
        .mini-dice-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.6); border: 1px solid #777; color: #ccc; cursor: pointer; font-family: 'Lato', sans-serif; font-weight: bold; transition: 0.2s; }
        .mini-dice-btn:hover { border-color: #f1c40f; color: #f1c40f; transform: scale(1.1); background: rgba(0,0,0,0.9); }
        button.roll-btn { padding: 12px 50px; font-family: 'Cinzel', serif; font-size: 20px; font-weight: 800; color: #dcdde1; background: linear-gradient(180deg, #3a423b 0%, #1a1d1a 100%); border: 1px solid #57606f; border-radius: 4px; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.6); text-transform: uppercase; letter-spacing: 2px; transition: all 0.2s ease; z-index: 20;} 
        button.roll-btn:disabled { opacity: 0.6; cursor: not-allowed; } 
        .rolling .dice-container { animation: shakeDice 0.6s ease-in-out infinite; } .rolling .dice-number { display: none; }
        @keyframes rotateCircle { from { transform: rotate(0deg); } to { transform: rotate(360deg); } } @keyframes shakeDice { 0% { transform: rotateX(0); } 25% { transform: rotateX(10deg); } 50% { transform: rotateX(-5deg); } 75% { transform: rotateX(5deg); } 100% { transform: rotateX(0); } }
        .crit-success { color: #f1c40f !important; text-shadow: 0 0 30px #f1c40f; } .crit-fail { color: #e74c3c !important; text-shadow: 0 0 30px #c0392b; }
        .toggle-sum { font-size: 14px; color: #aaa; padding: 8px 15px; border: 1px solid #555; border-radius: 20px; background: rgba(0,0,0,0.5); cursor: pointer; display: flex; align-items: center; gap: 8px; transition:0.3s; margin-bottom: 10px; }
        .toggle-sum.active { color: #2ecc71; border-color: #2ecc71; background: rgba(46, 204, 113, 0.2); font-weight:bold; box-shadow:0 0 10px rgba(46,204,113,0.3); }
        .dice-controls { display:flex; flex-direction:column; align-items:center; z-index:20; margin-top: 20px; }

        #wheelOverlayContainer { z-index: 6000; }
        .wheel-container { position: relative; width: 300px; height: 300px; }
        .wheel { width: 100%; height: 100%; border-radius: 50%; border: 5px solid #dcdde1; box-shadow: 0 0 20px rgba(0,0,0,0.5); background: conic-gradient(#e74c3c 0% 12.5%, #f1c40f 12.5% 25%, #3498db 25% 37.5%, #9b59b6 37.5% 50%, #2ecc71 50% 62.5%, #e67e22 62.5% 75%, #1abc9c 75% 87.5%, #95a5a6 87.5% 100%); transition: transform 4s; }
        .wheel-pointer { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 20px solid transparent; border-right: 20px solid transparent; border-top: 30px solid #fff; z-index: 10; }
        #wheelResultText { margin-top: 30px; font-size: 28px; color: #f1c40f; font-weight: bold; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-shadow: 0 0 10px #000; z-index: 6005; pointer-events: none;}
        #dmLogModal > div { background:#111; padding:20px; border:1px solid #e84393; width:500px; height:400px; display:flex; flex-direction:column; }
        #dmLogList { flex:1; overflow-y:auto; border:1px solid #333; margin:10px 0; text-align:left; padding:5px; font-size:12px; }
        .secret-entry { margin-bottom: 5px; border-left: 2px solid #555; padding: 2px; }
        .secret-dm-sent { border-color: #e84393; background: rgba(232, 67, 147, 0.1); } .secret-dm-received { border-color: #0984e3; background: rgba(9, 132, 227, 0.1); } .secret-p2p { border-color: #f1c40f; background: rgba(241, 196, 15, 0.1); }
        .log-panel { position: fixed; right: 20px; bottom: 20px; width: 220px; max-height: 300px; height: auto; padding: 10px; z-index: 2000; display: flex; flex-direction: column; background: rgba(18, 20, 16, 0.95); border: 1px solid #4b6b44; border-radius: 8px; }
        .log-panel.collapsed { height: 40px !important; overflow: hidden; }
        .log-list { overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column-reverse; gap: 5px; min-height: 200px; font-size: 12px; }
        .log-entry { padding: 5px; border-radius: 4px; background: rgba(255,255,255,0.08); display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div id="partyToggleBtn" class="floating-btn" title="Karakterler"><i class="fas fa-users"></i></div>
    <div id="dmToolsBtn" class="floating-btn" title="DM Araçları"><i class="fas fa-dragon"></i></div>
    <div id="identityBtn" class="floating-btn" title="Ben Kimim?"><i class="fas fa-id-card"></i><div id="currentIdentityDisplay">Seç</div></div>
    <div id="msgDmBtn" class="floating-btn" title="DM'e Mesaj At"><i class="fas fa-envelope"></i></div>
    <div id="dmLogBtn" class="floating-btn" title="DM Gizli Kayıtları"><i class="fas fa-book-dead"></i></div>
    <div id="battleModeBtn" class="floating-btn" title="Savaş Modu" onclick="toggleBattleMode()"><i class="fas fa-swords"></i></div>

    <div class="side-drawer" id="partyDrawer">
        <div class="drawer-header"><span>KAHRAMANLAR</span><div style="font-size:10px; cursor:pointer; color:#c0392b" onclick="resetPartyData()">SIFIRLA</div></div>
        <div id="characterList"></div>
        <button class="dm-btn" style="border-color:#7bed9f; color:#7bed9f;" onclick="addCharacter()">+ YENİ KARAKTER</button>
    </div>

    <div class="side-drawer" id="dmDrawer">
        <div class="drawer-header" style="color:#e74c3c; border-color:#e74c3c;"><span>DM ARAÇLARI</span></div>
        <div class="dm-tool-row">
            <div class="dm-tool-title">DÜŞMAN EKLE</div>
            <select id="bestiarySelect" class="bestiary-select" onchange="fillMonsterStats()">
                <option value="">-- Hazır Düşman Seç --</option>
                <option value="goblin">Goblin (HP:7)</option>
                <option value="orc">Ork (HP:15)</option>
                <option value="skeleton">İskelet (HP:13)</option>
                <option value="zombie">Zombi (HP:22)</option>
                <option value="bandit">Haydut (HP:11)</option>
                <option value="dragon">Genç Ejderha (HP:120)</option>
            </select>
            <input type="text" id="enemyNameInput" class="dm-input" placeholder="İsim (Örn: Goblin)">
            <input type="number"
